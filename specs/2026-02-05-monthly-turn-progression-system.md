# 月次ターン進行システム

## 要件

メインゲーム画面の開発を開始するにあたり、ゲームのコアループ（観察→判断→実行→結果確認）の土台となる月次ターン進行システムが必要である。

### 背景
- Phase 1（コアループの確立）の実装段階
- 予算配分、政策実行、支持率など全ての機能がターン進行に依存する
- 小さく小分けに開発を進めるため、最も基礎的な機能から着手する

### 目的
- ゲーム内時間（年月）を管理する仕組みを構築
- プレイヤーが「次の月へ」ボタンで時間を進められるようにする
- 他の機能を実装する際の基盤を整える

## 仕様

### 機能要件

#### ゲーム状態の保持
- 現在の年月を保持する（例: 2024年4月）
- 初期値: ゲーム開始時の年月（シナリオにより異なる可能性があるが、初期実装では固定値でよい）

#### ターン進行機能
- 「次の月へ」ボタンを押すと、現在の月を1ヶ月進める
- 12月の次は翌年1月に遷移する

#### UI表示
- メインゲーム画面に現在の日付を表示する
- 表示形式: 「YYYY年MM月」（例: 2024年04月）

### 非機能要件
- ゲーム状態は永続化可能な形式で保持する（将来のセーブ機能のため）
- UIとロジックを分離し、テスト可能な設計とする

### 制約事項
- 現時点では以下の機能は実装しない（将来のフェーズで実装）:
  - イベントの発生
  - 予算や政策の効果計算
  - 選挙や議会などの定期イベント

## 設計

### アーキテクチャ方針
TDD（テクニカルデザインドキュメント）の「5-1. 設計原則」に従い、以下を採用する:

1. **ロジックとUnity依存の分離**: ビジネスロジックを純粋なC#クラス（POCO）として実装
2. **依存性注入（DI）**: インターフェースを通じて依存関係を注入
3. **イミュータブルなデータ構造**: 状態変更は新しいオブジェクトを返す形式

### コンポーネント設計

#### 1. GameDate（データモデル）
- 責務: ゲーム内の年月を表現する
- 型: イミュータブルな値オブジェクト
- プロパティ:
  - `int Year`: 年
  - `int Month`: 月（1-12）
- メソッド:
  - `GameDate AddMonths(int months)`: 指定月数を加算した新しいGameDateを返す
  - `string ToDisplayString()`: 表示用文字列を返す（例: "2024年04月"）

#### 2. GameState（データモデル）
- 責務: ゲーム全体の状態を保持する
- 型: イミュータブルな値オブジェクト
- プロパティ:
  - `GameDate CurrentDate`: 現在の日付
  - （将来的に予算、支持率などを追加）

#### 3. TurnManager（ビジネスロジック）
- 責務: ターン進行のロジックを担当
- 型: 純粋なC#クラス（MonoBehaviourではない）
- メソッド:
  - `GameState ProgressToNextMonth(GameState currentState)`: 現在の状態から次の月の状態を生成

#### 4. GameStatePresenter（Presentation層）
- 責務: ゲーム状態をUIに反映する
- 型: MonoBehaviour
- 依存関係:
  - `TurnManager`: ターン進行ロジック
  - UI要素への参照
- メソッド:
  - `void Initialize(GameState initialState)`: 初期状態の設定
  - `void OnNextMonthButtonClicked()`: ボタンクリック時の処理

### フォルダ構成

```
Assets/MainGame/Scripts/
├── Runtime/
│   ├── Domain/
│   │   ├── Models/
│   │   │   ├── GameDate.cs
│   │   │   └── GameState.cs
│   │   └── Systems/
│   │       └── TurnManager.cs
│   └── Presentation/
│       └── GameStatePresenter.cs
```

### UI設計

#### メインゲーム画面レイアウト（初期版）
```
┌─────────────────────────┐
│  2024年04月             │ ← 日付表示（上部）
│                         │
│                         │
│    （ゲーム画面）         │
│                         │
│                         │
│                         │
│   [次の月へ]             │ ← ボタン（下部中央）
└─────────────────────────┘
```

### データフロー

```
ユーザー操作（ボタンクリック）
  ↓
GameStatePresenter.OnNextMonthButtonClicked()
  ↓
TurnManager.ProgressToNextMonth(currentState)
  ↓
新しいGameStateを生成
  ↓
GameStatePresenterが新しい状態をUIに反映
```

### テスト方針

#### Edit Mode テスト（優先度: 高）
- `GameDate.AddMonths()`: 月の加算ロジック、年をまたぐケース
- `TurnManager.ProgressToNextMonth()`: ターン進行ロジック

#### Play Mode テスト（優先度: 中）
- ボタンクリックで画面表示が更新されること

### 実装の優先順位

1. `GameDate` クラスの実装とテスト
2. `GameState` クラスの実装とテスト
3. `TurnManager` クラスの実装とテスト
4. `GameStatePresenter` の実装
5. MainGameScene への UI 配置
6. 統合テスト

## テストケース

### GameDate クラス

**テスト技法**: 境界値分析、同値分割法

| ID | テストケース | 検証内容 |
|----|------------|---------|
| TC-GD-01 | `AddMonths(1)` - 通常の月 | 通常の月（1-11月）に1ヶ月加算すると、同じ年の次の月になることを検証 |
| TC-GD-03 | `AddMonths(1)` - 12月 | 12月に1ヶ月加算すると、翌年の1月になることを検証 |
| TC-GD-05 | `AddMonths(12)` | 12ヶ月加算すると、1年後の同じ月になることを検証 |
| TC-GD-07 | `AddMonths(0)` | 0ヶ月加算すると、同じ年月のまま変わらないことを検証 |
| TC-GD-10 | `AddMonths(-1)` - 通常の月 | 負の月数を加算すると、過去の月に戻ることを検証（2月→1月） |
| TC-GD-12 | `AddMonths(-1)` - 1月 | 1月に-1ヶ月加算すると、前年の12月になることを検証 |
| TC-GD-15 | `ToDisplayString()` - 1桁の月 | 1桁の月（1-9月）がゼロパディングされて「YYYY年MM月」形式で返されることを検証 |
| TC-GD-17 | `ToDisplayString()` - 2桁の月 | 2桁の月（10-12月）が「YYYY年MM月」形式で返されることを検証 |

### GameState クラス

**テスト技法**: 同値分割法

| ID | テストケース | 検証内容 |
|----|------------|---------|
| TC-GS-01 | コンストラクタ | GameDateを渡すと、そのGameDateが`CurrentDate`プロパティで取得できることを検証 |
| TC-GS-03 | イミュータビリティ | 同じGameDateで作成したGameStateは常に同じ状態を保持することを検証 |

### TurnManager クラス

**テスト技法**: 同値分割法、境界値分析

| ID | テストケース | 検証内容 |
|----|------------|---------|
| TC-TM-01 | `ProgressToNextMonth()` - 通常の月 | 通常の月のGameStateを渡すと、1ヶ月進んだGameStateが返されることを検証 |
| TC-TM-03 | `ProgressToNextMonth()` - 12月 | 12月のGameStateを渡すと、翌年1月のGameStateが返されることを検証 |
| TC-TM-05 | `ProgressToNextMonth()` - イミュータビリティ | 元のGameStateは変更されないことを検証 |

### GameStatePresenter クラス（統合テスト）

**テスト技法**: 状態遷移テスト

| ID | テストケース | 検証内容 |
|----|------------|---------|
| TC-GSP-01 | `Initialize()` | 初期GameStateを渡すと、UI上に正しい日付が表示されることを検証 |
| TC-GSP-03 | `OnNextMonthButtonClicked()` - 通常の月 | ボタンクリック後、UI上の日付表示が1ヶ月進むことを検証 |
| TC-GSP-05 | `OnNextMonthButtonClicked()` - 12月 | 12月の状態でボタンクリック後、UI上の日付表示が翌年1月になることを検証 |

## 将来の拡張

この基盤の上に、以下の機能を段階的に追加していく:
- 財政状況の表示と更新
- 支持率の表示と変動
- 予算配分システム
- 政策実行システム
- イベントシステム
